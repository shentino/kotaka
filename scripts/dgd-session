#!/bin/bash

cd ~/git/kotaka

DGDPID=0

function sigterm
{
	kill -TERM $DGDPID
	kill -KILL $MONPID
	trap - SIGTERM
	kill -TERM $$
}

function sigint
{
	kill -KILL $DGDPID
	kill -KILL $MONPID
	trap - SIGINT
	kill -INT $$
}

function crashed
{
	echo "Found a core dump!"

	rm -rf crash
	mkdir crash

	gdb dgd mud/core -batch -ex bt > crash/trace
	mv mud/core crash
}

trap sigterm SIGTERM
trap sigint SIGINT

rm -f mud/core

while true
do
	if [ -f dump ]
	then
		echo "*** DGD warm booting ***" >> kotaka.err
		~/bin/dgd kotaka.dgd dump < /dev/null >> ulario.err 2>&1 &
	else
		echo "*** DGD cold booting ***" >> kotaka.err
		~/bin/dgd kotaka.dgd < /dev/null >> ulario.err 2>&1 &
	fi

	DGDPID=$!
	wait

	echo "dgd ended" >> kotaka.err

	if [ -f mud/core ]
	then
		echo ">>> DGD crashed <<<" >> kotaka.err
		crashed
	else
		echo "*** DGD terminated ***" >> kotaka.err
	fi
done
